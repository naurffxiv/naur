name: Pipeline E2E

on:
  workflow_call:
    inputs:
      should_run:
        required: false
        type: boolean
        default: true

jobs:
  e2e:
    if: inputs.should_run
    runs-on: ubuntu-latest
    timeout-minutes: 20

    defaults:
      run:
        working-directory: tests/e2e

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0
      - uses: crazy-max/ghaction-github-runtime@3cb05d89e1f492524af3d41a1c98c83bc3025124 # v3.1.0

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: Get Playwright version
        id: playwright-version
        run: |
          PLAYWRIGHT_VERSION=$(pnpm list @playwright/test --depth=0 --json | jq -r '.[ ] | (.devDependencies["@playwright/test"].version // .dependencies["@playwright/test"].version) | select(. != null)' | head -n 1)
          if [ -z "$PLAYWRIGHT_VERSION" ]; then
            echo "Error: Playwright version not found in pnpm list output."
            exit 1
          fi
          echo "version=$PLAYWRIGHT_VERSION" >> $GITHUB_OUTPUT

      - uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}
          restore-keys: playwright-${{ runner.os }}-

      - name: Install Playwright
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install --with-deps chromium

      - name: Install Playwright Dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps chromium

      - name: Build and Start Services
        env:
          DOCKER_BUILDKIT: 1
          COMPOSE_DOCKER_CLI_BUILD: 1
          DISCORD_CLIENT_ID: ${{ secrets.DISCORD_CLIENT_ID }}
          DISCORD_CLIENT_SECRET: ${{ secrets.DISCORD_CLIENT_SECRET }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
        run: |
          for i in {1..3}; do
            docker compose build \
              --parallel \
              --build-arg BUILDKIT_INLINE_CACHE=1 \
              authingway moddingway naurffxiv && break
            echo "Retrying Docker build ($i)..."
            sleep 10
          done
          docker compose up -d --wait --timeout 300 || { docker compose logs; exit 1; }

      - name: Run E2E Tests
        id: playwright
        continue-on-error: true
        run: pnpm exec playwright test 2>&1 | tee e2e_output.txt

      - name: Report E2E Status
        if: always()
        run: |
          outcome="${{ steps.playwright.outcome }}"
          for svc in naurffxiv moddingway authingway; do
             bash ../../.github/scripts/save_report.sh "$svc" 50 "E2E" "$outcome" e2e_output.txt
          done

          if [[ "$outcome" == "failure" ]]; then
            exit 1
          fi

      - name: Upload Artifacts
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: playwright-results
          path: |
            tests/e2e/playwright-report/
            tests/e2e/test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload Reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: report-e2e
          path: |
            tests/e2e/summary-*.md
            tests/e2e/logs-*.md
            tests/e2e/report-*.json
          retention-days: 1

      - name: Cleanup
        if: always()
        run: docker compose down -v

      - name: Cache Stats
        if: always()
        run: |
          echo "Playwright cache hit: ${{ steps.playwright-cache.outputs.cache-hit }}"
