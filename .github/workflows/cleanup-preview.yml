name: Cleanup Preview Environment

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547 # v1.12.0
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const { owner, repo } = context.repo;
            const suffix = `-pr-${context.payload.pull_request.number}`;

            const { data: { environments } } = await github.rest.repos.getAllEnvironments({ owner, repo });

            const targets = environments.filter(e => e.name.startsWith('preview-') && e.name.endsWith(suffix));

            if (targets.length === 0) {
              console.log(`No environments found for PR #${context.payload.pull_request.number}`);
              return;
            }

            for (const env of targets) {
              await github.rest.repos.deleteAnEnvironment({ owner, repo, environment_name: env.name });
              console.log(`Deleted: ${env.name}`);
            }
