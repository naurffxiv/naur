name: "Security Scan"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * 0" # Weekly Sunday at 2:00 AM UTC
  push:
    branches:
      - main
    paths:
      - ".github/workflows/security.yml"
      - "services/**"
      - "tests/**"
  pull_request:
    branches:
      - main

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      languages: ${{ steps.set-matrix.outputs.languages }}
      any_changed: ${{ steps.filter.outputs.any_changed }}
      workflow_changed: ${{ steps.filter.outputs.workflow }}
      changes: ${{ steps.filter.outputs.changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Filter Paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            javascript:
              - 'services/naurffxiv/**'
              - 'package.json'
              - 'package-lock.json'
            python:
              - 'services/moddingway/**'
              - 'pyproject.toml'
              - 'requirements.txt'
              - 'requirements-dev.txt'
            go:
              - 'services/clearingway/**'
              - 'services/findingway/**'
              - 'go.mod'
              - 'go.sum'
            csharp:
              - 'services/authingway/**'
              - 'services/apphost/**'
              - '**/*.csproj'
              - '**/*.sln'
            workflow:
              - '.github/workflows/security.yml'

      - name: Set Language Matrix
        id: set-matrix
        run: echo 'languages=["javascript", "python", "go", "csharp"]' >> $GITHUB_OUTPUT

  analyze:
    name: CodeQL Analysis (${{ matrix.language }})
    needs: detect-changes
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ${{ fromJSON(needs.detect-changes.outputs.languages) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        id: init
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          queries: security-extended

      - name: Autobuild
        if: matrix.language != 'csharp' && steps.init.outcome == 'success'
        uses: github/codeql-action/autobuild@v4

      - name: Build C#
        if: matrix.language == 'csharp' && steps.init.outcome == 'success'
        run: |
          dotnet build services/authingway
          dotnet build services/apphost

      - name: Perform CodeQL Analysis
        if: steps.init.outcome == 'success'
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{matrix.language}}"

  security-scan:
    name: Vulnerability Scanning (Trivy - ${{ matrix.service }})
    needs: detect-changes
    if: |
      github.event_name != 'pull_request' ||
      needs.detect-changes.outputs.workflow_changed == 'true' ||
      needs.detect-changes.outputs.any_changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        service:
          [
            "services/naurffxiv",
            "services/clearingway",
            "services/findingway",
            "services/moddingway",
            "services/authingway",
            "services/apphost",
          ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        env:
          TRIVY_SKIP_VERSION_CHECK: "true"
        with:
          scan-type: "fs"
          scan-ref: "${{ matrix.service }}"
          trivy-config: .github/trivy.yaml
          format: "sarif"
          output: "trivy-results-${{ strategy.job-index }}.sarif"
          exit-code: "0" # Don't fail the SARIF generation step, we fail later in the table step

      - name: Run Trivy (Table Output)
        uses: aquasecurity/trivy-action@0.33.1
        env:
          TRIVY_SKIP_VERSION_CHECK: "true"
        with:
          scan-type: "fs"
          scan-ref: "${{ matrix.service }}"
          trivy-config: .github/trivy.yaml
          format: "table"
          exit-code: "1"

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "trivy-results-${{ strategy.job-index }}.sarif"
          category: "trivy-${{ matrix.service }}"

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [analyze, security-scan]
    if: always()
    permissions:
      contents: read
    steps:
      - name: Summary
        run: |
          echo "### Security Scan Results" >> $GITHUB_STEP_SUMMARY

          ANALYZE_RESULT="${{ needs.analyze.result }}"
          SCAN_RESULT="${{ needs.security-scan.result }}"

          echo "- CodeQL Analysis: $ANALYZE_RESULT" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy Vulnerability Scan: $SCAN_RESULT" >> $GITHUB_STEP_SUMMARY

          if [[ "$ANALYZE_RESULT" == "failure" ]] || [[ "$SCAN_RESULT" == "failure" ]] || \
             [[ "$ANALYZE_RESULT" == "cancelled" ]] || [[ "$SCAN_RESULT" == "cancelled" ]]; then
            echo "::error::Security checks failed or were cancelled."
            echo "Security checks failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "All security checks passed or skipped." >> $GITHUB_STEP_SUMMARY
