# act -W .github/workflows/pipeline-node.yml --input service=naurffxiv --input node-version=22 --container-architecture linux/amd64
name: Pipeline Node

on:
  workflow_call:
    inputs:
      service:
        required: true
        type: string
      node-version:
        required: false
        type: string
        default: "22"
      upload-build-artifact:
        required: false
        type: boolean
        default: false
      should_run:
        required: false
        type: boolean
        default: true

jobs:
  lint-and-build:
    if: inputs.should_run
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ inputs.node-version }}
          cache: "pnpm"

      - name: Register Problem Matchers
        uses: ./.github/actions/setup-matchers

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Prettier
        uses: ./.github/actions/run-command-with-report
        with:
          service: ${{ inputs.service }}
          step-number: 10
          step-name: "Prettier"
          command: pnpm exec prettier --check --ignore-unknown "services/${{ inputs.service }}/**/*"
          output-file: prettier.txt

      - name: TypeScript
        uses: ./.github/actions/run-command-with-report
        if: always()
        with:
          service: ${{ inputs.service }}
          step-number: 10
          step-name: "TypeScript"
          command: pnpm typecheck
          output-file: tsc.txt
          working-directory: services/${{ inputs.service }}

      - name: ESLint
        uses: ./.github/actions/run-command-with-report
        if: always()
        with:
          service: ${{ inputs.service }}
          step-number: 10
          step-name: "ESLint"
          command: pnpm lint
          output-file: eslint.txt
          working-directory: services/${{ inputs.service }}

      - name: Build
        uses: ./.github/actions/run-command-with-report
        with:
          service: ${{ inputs.service }}
          step-number: 20
          step-name: "Build"
          command: pnpm build
          output-file: build.txt
          working-directory: services/${{ inputs.service }}

      - name: Upload Build Artifact
        if: inputs.upload-build-artifact == true && success()
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: build-${{ inputs.service }}
          path: |
            services/${{ inputs.service }}/.next
            services/${{ inputs.service }}/public
            services/${{ inputs.service }}/package.json
            services/${{ inputs.service }}/next.config.mjs
            services/${{ inputs.service }}/postcss.config.mjs
            services/${{ inputs.service }}/tailwind.config.js
          include-hidden-files: true
          retention-days: 1

  test:
    if: inputs.should_run
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ inputs.node-version }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Unit Tests
        uses: ./.github/actions/run-command-with-report
        with:
          service: ${{ inputs.service }}
          step-number: 30
          step-name: "Unit Tests"
          command: pnpm test 2>&1 || echo "No test script found"
          output-file: test.txt
          working-directory: services/${{ inputs.service }}
          fail-on-error: false
