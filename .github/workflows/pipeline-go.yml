name: Pipeline Go

on:
  workflow_call:
    inputs:
      service:
        required: true
        type: string
      go-version:
        required: true
        type: string
      should_run:
        required: false
        type: boolean
        default: true

jobs:
  lint:
    if: inputs.should_run
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}
          cache-dependency-path: services/${{ inputs.service }}/go.sum

      - name: Register Problem Matchers
        uses: ./.github/actions/setup-matchers

      - name: Format
        uses: ./.github/actions/run-command-with-report
        with:
          service: ${{ inputs.service }}
          step-number: 10
          step-name: "Format"
          command: |
            UNFORMATTED=$(gofmt -l services/${{ inputs.service }})
            if [ -n "$UNFORMATTED" ]; then
              echo "The following files are not formatted:"
              echo "$UNFORMATTED"
              exit 1
            fi
            echo "All files are properly formatted"
          output-file: gofmt.txt
          fail-on-error: true

      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.8.0
          install-only: true

      - name: Lint
        uses: ./.github/actions/run-command-with-report
        with:
          service: ${{ inputs.service }}
          step-number: 11
          step-name: "Lint"
          command: cd services/${{ inputs.service }} && golangci-lint run --timeout 5m --output.text.path=stdout --output.text.colors=false --path-prefix services/${{ inputs.service }}
          output-file: lint.txt
          fail-on-error: true

  build:
    if: inputs.should_run
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}
          cache-dependency-path: services/${{ inputs.service }}/go.sum

      - name: Build
        uses: ./.github/actions/run-command-with-report
        with:
          service: ${{ inputs.service }}
          step-number: 20
          step-name: "Build"
          command: cd services/${{ inputs.service }} && go build -v ./... 2>&1 | sed "s|^|services/${{ inputs.service }}/|"
          output-file: build.txt
          fail-on-error: true

  test:
    needs: [build]
    if: inputs.should_run
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}
          cache-dependency-path: services/${{ inputs.service }}/go.sum

      - name: Unit Tests
        uses: ./.github/actions/run-command-with-report
        with:
          service: ${{ inputs.service }}
          step-number: 30
          step-name: "Unit Tests"
          command: cd services/${{ inputs.service }} && go test -v -coverprofile=coverage.out ./... 2>&1 | sed "s|^|services/${{ inputs.service }}/|"
          output-file: test.txt
          fail-on-error: false
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}

      - name: Upload Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-go-${{ inputs.service }}
          path: services/${{ inputs.service }}/coverage.out
          if-no-files-found: warn
          retention-days: 1

  coverage-report:
    needs: [test]
    if: inputs.should_run && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: fgrosse/go-coverage-report@v1.2.0
        with:
          coverage-artifact-name: "coverage-go-${{ inputs.service }}"
          coverage-file-name: "coverage.out"
          root-package: "${{ inputs.service }}"
