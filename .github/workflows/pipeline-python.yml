name: Pipeline Python

on:
  workflow_call:
    inputs:
      service:
        required: true
        type: string
      python-version:
        required: false
        type: string
        default: "3.14"
      should_run:
        required: false
        type: boolean
        default: true

jobs:
  lint:
    if: inputs.should_run
    runs-on: ubuntu-latest
    strategy:
      matrix:
        check: [format, lint]
      fail-fast: false
    defaults:
      run:
        working-directory: services/${{ inputs.service }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          enable-cache: true
          python-version: ${{ inputs.python-version }}
          cache-dependency-glob: "services/${{ inputs.service }}/uv.lock"

      - name: Install Linting Tools
        run: uv sync --frozen --only-group dev

      - name: Ruff Format
        if: matrix.check == 'format'
        uses: ./.github/actions/run-command-with-report
        with:
          service: ${{ inputs.service }}
          step-number: 10
          step-name: "Ruff Format"
          command: uv run ruff format --check . ../../tests/${{ inputs.service }}
          output-file: format.txt
          working-directory: services/${{ inputs.service }}

      - name: Ruff Lint
        if: matrix.check == 'lint'
        uses: ./.github/actions/run-command-with-report
        with:
          service: ${{ inputs.service }}
          step-number: 10
          step-name: "Ruff Lint"
          command: uv run ruff check --output-format=github . ../../tests/${{ inputs.service }}
          output-file: lint.txt
          working-directory: services/${{ inputs.service }}

  build:
    needs: [lint]
    if: inputs.should_run
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/${{ inputs.service }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          enable-cache: true
          python-version: ${{ inputs.python-version }}
          cache-dependency-glob: "services/${{ inputs.service }}/uv.lock"

      - name: Install Dependencies
        run: uv sync --frozen --all-groups

      - name: Type Check
        uses: ./.github/actions/run-command-with-report
        with:
          service: ${{ inputs.service }}
          step-number: 20
          step-name: "Type Check"
          command: uv run ty check . ../../tests/${{ inputs.service }} --output-format=github
          working-directory: services/${{ inputs.service }}
          fail-on-error: true

  test:
    needs: [build]
    if: inputs.should_run
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/${{ inputs.service }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          enable-cache: true
          python-version: ${{ inputs.python-version }}
          cache-dependency-glob: "services/${{ inputs.service }}/uv.lock"

      - name: Install Dependencies
        run: uv sync --frozen --all-groups

      - name: Unit Tests
        uses: ./.github/actions/run-command-with-report
        with:
          service: ${{ inputs.service }}
          step-number: 30
          step-name: "Unit Tests"
          command: uv run pytest ../../tests/${{ inputs.service }} --cov=${{ inputs.service }} --cov-report=xml:../../tests/${{ inputs.service }}/coverage.xml
          output-file: pytest.txt
          working-directory: services/${{ inputs.service }}
          fail-on-error: true

      - name: Upload Coverage
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage-${{ inputs.service }}
          path: tests/${{ inputs.service }}/coverage.xml
          if-no-files-found: ignore
          retention-days: 1
