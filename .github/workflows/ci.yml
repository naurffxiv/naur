name: CI

on:
  pull_request:
    types: [opened, reopened, synchronize, edited]
    branches: [main]
  push:
    branches: [main]

permissions:
  pull-requests: write
  contents: read
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    name: Detect Service Changes
    runs-on: ubuntu-latest
    outputs:
      naurffxiv: ${{ steps.filter.outputs.naurffxiv }}
      moddingway: ${{ steps.filter.outputs.moddingway }}
      authingway: ${{ steps.filter.outputs.authingway }}
      findingway: ${{ steps.filter.outputs.findingway }}
      clearingway: ${{ steps.filter.outputs.clearingway }}
      AppHost: ${{ steps.filter.outputs.AppHost }}
      run_e2e: ${{ steps.e2e-check.outputs.run_e2e }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            naurffxiv   : ['services/naurffxiv/**']
            moddingway  : ['services/moddingway/**']
            findingway  : ['services/findingway/**']
            clearingway : ['services/clearingway/**']
            authingway  : ['services/authingway/**']
            AppHost     : ['services/apphost/**']
            e2e_required:
              - 'services/naurffxiv/src/app/api/**'
              - 'services/moddingway/moddingway_api/**'
              - 'services/authingway/**'
              - 'services/apphost/**'
              - '**/package.json'
              - '**/requirements.txt'
              - '**/*.csproj'
              - '**/Dockerfile'
              - 'tests/e2e/**'

      - name: Check E2E Status
        id: e2e-check
        env:
          HEAD_COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: echo "run_e2e=false" >> $GITHUB_OUTPUT
  #          # Determine commit message source based on event type
  #          if [[ "${{ github.event_name }}" == "push" ]]; then
  #            MSG="$HEAD_COMMIT_MSG"
  #          else
  #            MSG="$(jq -r '.pull_request.title // ""' "$GITHUB_EVENT_PATH") $(jq -r '.pull_request.body // ""' "$GITHUB_EVENT_PATH")"
  #          fi
  #
  #          if [[ "$MSG" == *"[skip e2e]"* ]]; then
  #            echo "run_e2e=false" >> $GITHUB_OUTPUT
  #          elif [[ "$MSG" == *"[force e2e]"* ]]; then
  #            echo "run_e2e=true" >> $GITHUB_OUTPUT
  #          else
  #            echo "run_e2e=${{ steps.filter.outputs.e2e_required }}" >> $GITHUB_OUTPUT
  #          fi

  ci-check-ticket:
    uses: ./.github/workflows/pipeline-ticket.yml

  ci-node:
    needs: [detect-changes]
    if: github.event_name == 'push' || needs.detect-changes.outputs.naurffxiv == 'true'
    uses: ./.github/workflows/pipeline-node.yml
    with:
      service: naurffxiv
      node-version: "22"
      upload-build-artifact: ${{ github.event_name == 'pull_request' }}
      should_run: ${{ github.event_name == 'push' || needs.detect-changes.outputs.naurffxiv == 'true' }}
    secrets: inherit # pragma: allowlist secret

  ci-python:
    needs: [detect-changes]
    if: github.event_name == 'push' || needs.detect-changes.outputs.moddingway == 'true'
    uses: ./.github/workflows/pipeline-python.yml
    with:
      service: moddingway
      python-version: "3.11"
      should_run: ${{ github.event_name == 'push' || needs.detect-changes.outputs.moddingway == 'true' }}
    secrets: inherit

  ci-dotnet:
    needs: [detect-changes]
    if: |
      github.event_name == 'push' ||
      needs.detect-changes.outputs.authingway == 'true' ||
      needs.detect-changes.outputs.AppHost == 'true'
    strategy:
      matrix:
        service: [authingway, apphost]
      fail-fast: false
    uses: ./.github/workflows/pipeline-dotnet.yml
    with:
      service: ${{ matrix.service }}
      should_run: ${{ github.event_name == 'push' || needs.detect-changes.outputs[matrix.service] == 'true' }}
    secrets: inherit

  ci-go:
    needs: [detect-changes]
    if: |
      github.event_name == 'push' ||
      needs.detect-changes.outputs.findingway == 'true' ||
      needs.detect-changes.outputs.clearingway == 'true'
    strategy:
      matrix:
        service: [findingway, clearingway]
      fail-fast: false
    uses: ./.github/workflows/pipeline-go.yml
    with:
      service: ${{ matrix.service }}
      go-version: '1.25.0'
      should_run: ${{ github.event_name == 'push' || needs.detect-changes.outputs[matrix.service] == 'true' }}
    secrets: inherit

  deploy-preview:
    needs: [detect-changes, ci-node]
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.naurffxiv == 'true'
    uses: ./.github/workflows/deploy-pr-netlify.yml
    with:
      pr_number: "${{ github.event.pull_request.number }}"
      should_run: ${{ github.event_name == 'pull_request' && needs.detect-changes.outputs.naurffxiv == 'true' }}
    secrets: inherit

  e2e:
    needs: [detect-changes, ci-node, ci-python, ci-dotnet, ci-go]
    if: "!failure() && !cancelled() && needs.detect-changes.outputs.run_e2e == 'true'"
    uses: ./.github/workflows/pipeline-e2e.yml
    with:
      should_run: ${{ needs.detect-changes.outputs.run_e2e == 'true' }}
    secrets: inherit

  post-report:
    needs:
      [
        detect-changes,
        ci-check-ticket,
        ci-node,
        ci-python,
        ci-dotnet,
        ci-go,
        deploy-preview,
        e2e,
      ]
    if: always()
    uses: ./.github/workflows/report.yml
    with:
      run_e2e: ${{ needs.detect-changes.outputs.run_e2e }}
    secrets: inherit
