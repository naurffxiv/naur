name: Pipeline Ticket Check

on:
  workflow_call:

jobs:
  check-ticket:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Extract Ticket
        id: extract
        if: github.event_name == 'pull_request'
        uses: ./.github/actions/extract-pr-ticket

      - name: Check for Ticket Reference
        id: ticket
        env:
          MATCH: ${{ steps.extract.outputs.match }}
          IS_DEPENDABOT: ${{ steps.extract.outputs.is_dependabot }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          report() {
            local conclusion="$1"
            local log_file="${2:-}"
            local summary="${3:-}"
            bash .github/scripts/save_report.sh "global" "00" "Ticket Check" "$conclusion" "$log_file" "$summary"
          }

          if [[ "$EVENT_NAME" != "pull_request" || "$IS_DEPENDABOT" == "true" ]]; then
            report "success" "" "Skipped"
            exit 0
          fi

          if [[ -n "$MATCH" ]]; then
            TRIMMED_MATCH="$(printf '%s' "$MATCH" | xargs)"
            report "success" "" "${TRIMMED_MATCH:-Ticket Found}"
          else
            echo "Ticket reference missing in PR Title or Body" > ticket_err.txt
            report "failure" "ticket_err.txt" ""
            exit 1
          fi

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: report-ticket
          path: |
            summary-global-*.md
            logs-global-*.md
            report-global-*.json
          retention-days: 1
          if-no-files-found: warn
