name: Deploy PR Preview to Netlify

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: string
        description: "Pull Request Number"
      should_run:
        required: false
        type: boolean
        default: true

jobs:
  preview-deploy:
    if: inputs.should_run
    runs-on: ubuntu-latest
    timeout-minutes: 10

    environment:
      name: preview-naurffxiv-pr-${{ inputs.pr_number }}
      url: ${{ steps.netlify.outputs.deploy_url }}

    defaults:
      run:
        working-directory: services/naurffxiv

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: "22.12.0"
          cache: "pnpm"
          cache-dependency-path: "pnpm-lock.yaml"

      - name: Prepare Netlify Config
        run: |
          [[ -f ../../netlify.toml ]] && cp ../../netlify.toml . || echo "No root netlify.toml found"

      - name: Install Netlify CLI
        run: pnpm add -g netlify-cli

      - name: Install Dependencies
        working-directory: .
        run: pnpm install --frozen-lockfile

      - name: Configure Netlify State
        env:
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          mkdir -p .netlify
          echo "{\"siteId\": \"$NETLIFY_SITE_ID\"}" > .netlify/state.json

      - name: Deploy to Netlify
        id: netlify
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          netlify deploy \
            --build \
            --json \
            --alias "pr-${{ inputs.pr_number }}" \
            --message "PR #${{ inputs.pr_number }}: ${{ github.sha }}" \
            > deploy.json

          # Extract all the fields
          deploy_url=$(jq -r '.deploy_url // ""' deploy.json)
          site_url=$(jq -r '.url // ""' deploy.json)
          deploy_id=$(jq -r '.deploy_id // ""' deploy.json)
          logs_url=$(jq -r '.logs // ""' deploy.json)
          function_logs=$(jq -r '.function_logs // ""' deploy.json)
          edge_logs=$(jq -r '.edge_function_logs // ""' deploy.json)

          # Set outputs
          echo "deploy_url=$deploy_url" >> $GITHUB_OUTPUT
          echo "site_url=$site_url" >> $GITHUB_OUTPUT
          echo "deploy_id=$deploy_id" >> $GITHUB_OUTPUT
          echo "logs_url=$logs_url" >> $GITHUB_OUTPUT
          echo "function_logs=$function_logs" >> $GITHUB_OUTPUT
          echo "edge_logs=$edge_logs" >> $GITHUB_OUTPUT

          echo "Deployed to: $deploy_url"

      - name: Generate Report
        if: always()
        run: |
          url="${{ steps.netlify.outputs.deploy_url }}"
          logs="${{ steps.netlify.outputs.logs_url }}"
          pr="${{ inputs.pr_number }}"
          status="${{ job.status }}"

          # Call save_report.sh to generate both MD and JSON reports
          # Use "global" as service to place it in the header section
          bash ../../.github/scripts/save_report.sh \
            "global" "40" "Preview (naurffxiv)" "$status" "$logs" "$url"

      - name: Deploy Summary
        if: always()
        run: |
          echo "### Preview Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Preview URL:** ${{ steps.netlify.outputs.deploy_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy ID:** \`${{ steps.netlify.outputs.deploy_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Logs" >> $GITHUB_STEP_SUMMARY
          echo "- [Build Logs](${{ steps.netlify.outputs.logs_url }})" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.netlify.outputs.function_logs }}" != "" ]]; then
            echo "- [Function Logs](${{ steps.netlify.outputs.function_logs }})" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ steps.netlify.outputs.edge_logs }}" != "" ]]; then
            echo "- [Edge Function Logs](${{ steps.netlify.outputs.edge_logs }})" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Report Artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: report-deploy-naurffxiv
          path: |
            services/naurffxiv/summary-global-*.md
            services/naurffxiv/report-global-*.json
          retention-days: 1
